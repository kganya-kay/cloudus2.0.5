// =====================
// Prisma Configuration
// =====================
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =====================
// Enums
// =====================
enum FulfilmentStatus {
  NEW
  SOURCING_SUPPLIER
  SUPPLIER_CONFIRMED
  IN_PROGRESS
  READY_FOR_DELIVERY
  OUT_FOR_DELIVERY
  DELIVERED
  CLOSED
  CANCELED
}

enum EmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
  INTERN
  TEMP
}

enum OnsiteType {
  ONSITE
  HYBRID
  REMOTE
}

enum JobStatus {
  DRAFT
  OPEN
  CLOSED
}

enum ApplicationStatus {
  RECEIVED
  IN_REVIEW
  INTERVIEW
  OFFER
  HIRED
  REJECTED
  WITHDRAWN
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum DeliveryStatus {
  PENDING
  SCHEDULED
  PICKUP_IN_PROGRESS
  OUT_FOR_DELIVERY
  DELIVERED
  FAILED
  CANCELED
}

enum AddressType {
  BILLING
  SHIPPING
  OPERATIONS
  REGISTERED
  HOME
  OTHER
}

enum Role {
  ADMIN
  CARETAKER
  SUPPLIER
  CUSTOMER
  DRIVER
}

enum ProjectBidStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProjectTaskStatus {
  BACKLOG
  IN_PROGRESS
  SUBMITTED
  APPROVED
  REJECTED
  COMPLETED
}

enum ProjectTaskPayoutStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProjectTaskPayoutType {
  HALF
  FULL
  CUSTOM
}

enum FeedPostType {
  PROJECT_UPDATE
  SHOP_DROP
  VIDEO
  STORY
  ANNOUNCEMENT
}

enum CreatorTier {
  SEED
  RISING
  PRO
  PARTNER
  ENTERPRISE
}

enum CollaborationStatus {
  INVITED
  ACCEPTED
  DECLINED
  COMPLETED
}

enum RoomAdminStatus {
  PENDING
  APPROVED
  REJECTED
}

enum RoomAvailabilityStatus {
  AVAILABLE
  BLOCKED
  MAINTENANCE
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELED
  REFUNDED
  COMPLETED
}

enum RoomMediaType {
  IMAGE
  VIDEO
}

// =====================
// Shared Address Book
// =====================
model Address {
  id         Int      @id @default(autoincrement())
  line1      String
  line2      String?
  suburb     String?
  city       String
  province   String?
  postalCode String?
  country    String   @default("ZA")
  lat        Float?
  lng        Float?
  phone      String?
  notes      String?
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  userLinks     UserAddress[]
  supplierLinks SupplierAddress[]
  Order         Order[]
  roomListings  RoomListing[]
}

model UserAddress {
  id        Int         @id @default(autoincrement())
  userId    String
  addressId Int
  type      AddressType
  isDefault Boolean     @default(false)
  label     String?

  user    User    @relation(fields: [userId], references: [id])
  address Address @relation(fields: [addressId], references: [id])

  @@unique([userId, addressId, type])
  @@index([userId])
  @@index([addressId])
}

model SupplierAddress {
  id         Int         @id @default(autoincrement())
  supplierId String
  addressId  Int
  type       AddressType
  isDefault  Boolean     @default(false)
  label      String?

  supplier Supplier @relation(fields: [supplierId], references: [id])
  address  Address  @relation(fields: [addressId], references: [id])

  @@unique([supplierId, addressId, type])
  @@index([supplierId])
  @@index([addressId])
}

model Post {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  createdById String
  createdBy   User   @relation("PostCreatedBy", fields: [createdById], references: [id])

  @@index([name])
}

// =====================
// Creator & Feed Layer
// =====================
model CreatorProfile {
  id          String      @id @default(cuid())
  userId      String      @unique
  handle      String      @unique
  displayName String
  bio         String?
  tagline     String?
  avatarUrl   String?
  coverUrl    String?
  website     String?
  socialLinks String[]    @default([])
  skills      String[]    @default([])
  focusAreas  String[]    @default([])
  tier        CreatorTier @default(SEED)
  verified    Boolean     @default(false)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  user             User            @relation(fields: [userId], references: [id])
  followers        CreatorFollow[] @relation("CreatorFollowers")
  following        CreatorFollow[] @relation("CreatorFollowing")
  feedPosts        FeedPost[]
  earnings         CreatorEarning? @relation(fields: [creatorEarningId], references: [id])
  creatorEarningId String?
}

model CreatorFollow {
  id          Int      @id @default(autoincrement())
  followerId  String
  followingId String
  createdAt   DateTime @default(now())

  follower  CreatorProfile @relation("CreatorFollowing", fields: [followerId], references: [id])
  following CreatorProfile @relation("CreatorFollowers", fields: [followingId], references: [id])

  @@unique([followerId, followingId])
  @@index([followingId])
}

model CreatorEarning {
  id             String    @id @default(cuid())
  userId         String    @unique
  totalCents     Int       @default(0)
  availableCents Int       @default(0)
  lockedCents    Int       @default(0)
  lastPayoutAt   DateTime?

  user           User             @relation(fields: [userId], references: [id])
  CreatorProfile CreatorProfile[]
}

model FeedPost {
  id          String       @id @default(cuid())
  creatorId   String
  projectId   Int?
  shopItemId  Int?
  orderId     Int?
  type        FeedPostType @default(PROJECT_UPDATE)
  title       String?
  caption     String?
  tags        String[]     @default([])
  coverImage  String?
  isPinned    Boolean      @default(false)
  visibility  String       @default("PUBLIC")
  publishedAt DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  creator          CreatorProfile     @relation(fields: [creatorId], references: [id])
  project          Project?           @relation(fields: [projectId], references: [id])
  shopItem         ShopItem?          @relation(fields: [shopItemId], references: [id])
  order            Order?             @relation(fields: [orderId], references: [id])
  media            FeedMedia[]
  reactions        FeedReaction[]
  AdminReviewQueue AdminReviewQueue[]

  @@index([creatorId])
  @@index([projectId])
  @@index([shopItemId])
}

model FeedMedia {
  id        String   @id @default(cuid())
  postId    String
  url       String
  type      String   @default("IMAGE")
  metadata  Json?
  createdAt DateTime @default(now())

  post FeedPost @relation(fields: [postId], references: [id])

  @@index([postId])
}

model FeedReaction {
  id        String   @id @default(cuid())
  postId    String
  userId    String
  type      String   @default("LIKE")
  createdAt DateTime @default(now())

  post FeedPost @relation(fields: [postId], references: [id])
  user User     @relation(fields: [userId], references: [id])

  @@unique([postId, userId, type])
  @@index([userId])
}

// =====================
// Core Domain Models
// =====================
model Project {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // createdBy (name this relation to avoid ambiguity with contributors)
  createdById String
  createdBy   User   @relation("ProjectCreatedBy", fields: [createdById], references: [id])

  type              String
  category          String?                   @default("General")
  tags              String[]                  @default([])
  visibility        String                    @default("PUBLIC")
  featured          Boolean                   @default(false)
  heroVideo         String?
  price             Int                       @default(0)
  description       String
  image             String                    @default("https://utfs.io/f/zFJP5UraSTwK07wECkD6zpt79ehTVJxMrYIoKdqLl2gOj1Zf")
  count             Int                       @default(autoincrement())
  link              String
  links             String[]
  // Contributors (M-N) explicitly named
  contributors      User[]                    @relation("ProjectContributors")
  api               String
  openSource        Boolean                   @default(true)
  privacy           Boolean                   @default(false)
  completed         Boolean                   @default(false)
  status            String                    @default("Initialized")
  contactNumber     Int                       @default(00000000000)
  cost              Int                       @default(0)
  rating            Int                       @default(5)
  bids              ProjectBid[]
  tasks             ProjectTask[]
  payments          ProjectPayment[]
  paymentPreference ProjectPaymentPreference?
  followers         ProjectFollower[]
  invites           CollaborationInvite[]
  feedPosts         FeedPost[]

  // Social
  comments         Comment[]          @relation("ProjectComments")
  likes            Like[]             @relation("ProjectLikes")
  upvotes          Upvote[]           @relation("ProjectUpvotes")
  AdminReviewQueue AdminReviewQueue[]

  @@index([name])
}

model ProjectFollower {
  id        Int      @id @default(autoincrement())
  projectId Int
  userId    String
  createdAt DateTime @default(now())

  project Project @relation(fields: [projectId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([projectId, userId])
  @@index([userId])
}

model ShopItem {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // createdBy (explicitly named)
  createdById String
  createdBy   User   @relation("ShopItemCreatedBy", fields: [createdById], references: [id])

  type         String
  price        Int
  description  String
  image        String   @default("https://utfs.io/f/zFJP5UraSTwK07wECkD6zpt79ehTVJxMrYIoKdqLl2gOj1Zf")
  stock        Int      @default(0)
  count        Int      @default(autoincrement())
  link         String
  // Contributors (M-N) explicitly named
  contributors User[]   @relation("ShopItemContributors")
  api          String
  links        String[]

  // Supplier link (nullable for backward compatibility; enforce at creation time)
  supplierId String?
  supplier   Supplier? @relation(fields: [supplierId], references: [id])

  // One named relation to Order to avoid ambiguity
  orders Order[] @relation("ShopItemOrders")

  // Social
  comments         Comment[]          @relation("ShopItemComments")
  likes            Like[]             @relation("ShopItemLikes")
  upvotes          Upvote[]           @relation("ShopItemUpvotes")
  feedPosts        FeedPost[]
  AdminReviewQueue AdminReviewQueue[]

  @@index([name])
}

model Order {
  id        Int      @id @default(autoincrement())
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Creator
  createdById String
  createdBy   User   @relation("OrderCreatedBy", fields: [createdById], references: [id])

  price       Int // cents
  description String
  image       String   @default("https://utfs.io/f/zFJP5UraSTwK07wECkD6zpt79ehTVJxMrYIoKdqLl2gOj1Zf")
  count       Int      @default(autoincrement())
  link        String
  api         String
  links       String[]

  // Order item (catalog product) â€” optional for service orders
  createdForId Int?
  createdFor   ShopItem? @relation("ShopItemOrders", fields: [createdForId], references: [id])

  // Public tracking code
  code String @unique @default(cuid())

  // Customer (denormalized for speed)
  customerId    String? // optional: if you later add a Customer model
  customerName  String?
  customerPhone String?
  customerEmail String?

  // Address
  addressId    Int?
  address      Address? @relation(fields: [addressId], references: [id])
  addressLine1 String?
  suburb       String?
  city         String?

  // Money
  deliveryCents Int    @default(0)
  currency      String @default("ZAR")

  // Fulfilment
  status     FulfilmentStatus @default(NEW)
  supplierId String?
  supplier   Supplier?        @relation("SupplierOrders", fields: [supplierId], references: [id])

  // Payment
  paymentId String?
  payments  Payment[]

  // Caretaker (ops owner)
  caretakerId String?
  caretaker   User?     @relation("OrderCaretaker", fields: [caretakerId], references: [id])
  delivery    Delivery?

  // Ops
  estimatedKg   Float?
  payouts       SupplierPayout[]
  auditLogs     AuditLog[]
  SupplierQuote SupplierQuote[]
  feedPosts     FeedPost[]

  customerLocationLat      Float?
  customerLocationLng      Float?
  customerLocationAccuracy Float?
  customerLocationAt       DateTime?
  supplierLocationLat      Float?
  supplierLocationLng      Float?
  supplierLocationAccuracy Float?
  supplierLocationAt       DateTime?

  @@index([name])
  @@index([status])
  @@index([caretakerId])
  @@index([supplierId])
  @@index([createdForId])
  @@index([addressId])
}

model Payment {
  id          String        @id @default(cuid())
  orderId     Int
  amountCents Int
  currency    String        @default("ZAR")
  status      PaymentStatus @default(PENDING)
  provider    String // e.g., "PayFast", "Peach", "Ozow", "Stripe"
  providerRef String? // gateway charge id / reference
  receiptUrl  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([status])
}

model ProjectPaymentPreference {
  id                      String   @id @default(cuid())
  projectId               Int      @unique
  autopayEnabled          Boolean  @default(false)
  autopayThresholdPercent Int      @default(100)
  tipPercent              Int      @default(0)
  tipJarCents             Int      @default(0)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  project Project @relation(fields: [projectId], references: [id])
}

model ProjectPayment {
  id          String        @id @default(cuid())
  projectId   Int
  amountCents Int
  currency    String        @default("ZAR")
  status      PaymentStatus @default(PENDING)
  provider    String        @default("PAYSTACK")
  providerRef String?
  receiptUrl  String?
  purpose     String        @default("DEPOSIT")
  label       String?       @default("Milestone")
  sequence    Int?
  dueAt       DateTime?
  releasedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  project Project @relation(fields: [projectId], references: [id])

  @@index([projectId])
  @@index([status])
}

// =====================
// Social Entities
// =====================
model Comment {
  id          Int      @id @default(autoincrement())
  createdById String
  createdAt   DateTime @default(now())

  // Optional FK to Project
  projectId Int?
  project   Project? @relation("ProjectComments", fields: [projectId], references: [id])

  // Optional FK to ShopItem
  shopItemId Int?
  shopItem   ShopItem? @relation("ShopItemComments", fields: [shopItemId], references: [id])
}

model Upvote {
  id          Int      @id @default(autoincrement())
  createdById String
  createdAt   DateTime @default(now())

  projectId Int?
  project   Project? @relation("ProjectUpvotes", fields: [projectId], references: [id])

  shopItemId Int?
  shopItem   ShopItem? @relation("ShopItemUpvotes", fields: [shopItemId], references: [id])
}

model Like {
  id          Int      @id @default(autoincrement())
  createdById String
  createdAt   DateTime @default(now())

  projectId Int?
  project   Project? @relation("ProjectLikes", fields: [projectId], references: [id])

  shopItemId Int?
  shopItem   ShopItem? @relation("ShopItemLikes", fields: [shopItemId], references: [id])
}

// =====================
// Careers (Jobs)
// =====================
model Job {
  id              Int            @id @default(autoincrement())
  slug            String         @unique
  title           String
  summary         String
  description     String
  employmentType  EmploymentType
  onsiteType      OnsiteType
  locationCity    String?
  locationRegion  String?
  locationCountry String?        @default("ZA")
  remoteAllowed   Boolean        @default(false)
  tags            String[] // Postgres array
  currency        String         @default("ZAR")
  salaryMinCents  Int? // optional range
  salaryMaxCents  Int?
  status          JobStatus      @default(DRAFT)
  applyEmail      String? // e.g., careers@cloudus...
  applyWhatsapp   String? // e.g., 27640204765
  postedAt        DateTime       @default(now())
  expiresAt       DateTime?

  createdById String
  createdBy   User   @relation("JobCreatedBy", fields: [createdById], references: [id])

  applications JobApplication[]

  @@index([status])
  @@index([postedAt])
}

model JobApplication {
  id          String            @id @default(cuid())
  jobId       Int
  userId      String? // applicant if signed-in
  name        String
  email       String
  phone       String?
  resumeUrl   String?
  coverLetter String?
  answers     Json? // structured form answers
  source      String? // where they found the job
  linkedinUrl String?
  websiteUrl  String?
  status      ApplicationStatus @default(RECEIVED)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt

  job  Job   @relation(fields: [jobId], references: [id])
  user User? @relation("JobApplicationUser", fields: [userId], references: [id])

  @@index([jobId])
  @@index([userId])
  @@index([status])
}

// =====================
// NextAuth Models
// =====================
model Account {
  id                       String  @id @default(cuid())
  userId                   String
  type                     String
  provider                 String
  providerAccountId        String
  refresh_token            String? // @db.Text for mysql/sqlserver
  access_token             String? // @db.Text
  expires_at               Int?
  token_type               String?
  scope                    String?
  id_token                 String? // @db.Text
  session_state            String?
  user                     User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  refresh_token_expires_in Int?

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?   @unique
  emailVerified DateTime?
  image         String?
  passwordHash  String?

  accounts Account[]
  sessions Session[]

  role           Role            @default(CUSTOMER)
  isCreator      Boolean         @default(false)
  supplierId     String?
  supplier       Supplier?       @relation(fields: [supplierId], references: [id])
  driverId       String?
  driver         Driver?         @relation(fields: [driverId], references: [id])
  creatorProfile CreatorProfile?
  creatorEarning CreatorEarning?

  // Back-rels for created entities (explicit names to avoid clashes with M-N)
  projectsCreated  Project[]  @relation("ProjectCreatedBy")
  shopItemsCreated ShopItem[] @relation("ShopItemCreatedBy")
  ordersCreated    Order[]    @relation("OrderCreatedBy")
  caretakerOrders  Order[]    @relation("OrderCaretaker")

  // M-N contributor relations
  projectContributions         Project[]                  @relation("ProjectContributors")
  shopItemContributions        ShopItem[]                 @relation("ShopItemContributors")
  projectBids                  ProjectBid[]
  projectTasksAssigned         ProjectTask[]              @relation("ProjectTaskAssigned")
  projectTaskPayouts           ProjectTaskPayoutRequest[]
  projectFollowing             ProjectFollower[]
  feedReactions                FeedReaction[]
  collaborationInvitesSent     CollaborationInvite[]      @relation("CollaborationInviter")
  collaborationInvitesReceived CollaborationInvite[]      @relation("CollaborationInvitee")

  // Careers
  jobPosts        Job[]            @relation("JobCreatedBy")
  jobApplications JobApplication[] @relation("JobApplicationUser")

  // Addresses
  addresses         UserAddress[]
  // back-rel for posts authored by this user
  posts             Post[]              @relation("PostCreatedBy")
  notifications     Notification[]
  AdminAnnouncement AdminAnnouncement[]
  AdminReviewQueue  AdminReviewQueue[]
  roomListings      RoomListing[]
  bookingsAsGuest   Booking[]           @relation("BookingGuest")
  bookingsAsHost    Booking[]           @relation("BookingHost")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// =====================
// Fulfilment Layer
// =====================
model Supplier {
  id           String          @id @default(cuid())
  name         String
  phone        String
  addressLine1 String?
  email        String?
  suburb       String?
  city         String?
  type         String?
  description  String?
  pricePerKg   Int? // cents, for laundry
  isActive     Boolean         @default(true)
  rating       Float? // 1..5
  notes        String?
  quotes       SupplierQuote[]
  orders       Order[]         @relation("SupplierOrders")
  createdAt    DateTime        @default(now())

  addresses            SupplierAddress[]
  SupplierPayout       SupplierPayout[]
  User                 User[]
  shopItems            ShopItem[]
  lastLocationLat      Float?
  lastLocationLng      Float?
  lastLocationAccuracy Float?
  lastLocationAt       DateTime?
}

model ProjectBid {
  id        Int              @id @default(autoincrement())
  projectId Int
  userId    String
  amount    Int
  message   String?
  status    ProjectBidStatus @default(PENDING)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  project Project          @relation(fields: [projectId], references: [id])
  user    User             @relation(fields: [userId], references: [id])
  tasks   ProjectBidTask[]

  @@unique([projectId, userId], map: "project_bid_unique_user")
  @@index([projectId])
  @@index([userId])
}

model ProjectBidTask {
  id     Int @id @default(autoincrement())
  bidId  Int
  taskId Int

  bid  ProjectBid  @relation(fields: [bidId], references: [id])
  task ProjectTask @relation(fields: [taskId], references: [id])

  @@unique([bidId, taskId])
  @@index([taskId])
}

model ProjectTask {
  id             Int               @id @default(autoincrement())
  projectId      Int
  title          String
  description    String?
  budgetCents    Int
  status         ProjectTaskStatus @default(BACKLOG)
  assignedToId   String?
  submissionNote String?
  submittedAt    DateTime?
  approvedAt     DateTime?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime          @updatedAt
  skills         String[]          @default([])
  media          String[]          @default([])

  project        Project                    @relation(fields: [projectId], references: [id])
  assignedTo     User?                      @relation("ProjectTaskAssigned", fields: [assignedToId], references: [id])
  payoutRequests ProjectTaskPayoutRequest[]
  bidSelections  ProjectBidTask[]
  invites        CollaborationInvite[]

  @@index([projectId])
  @@index([assignedToId])
}

model ProjectTaskPayoutRequest {
  id          Int                     @id @default(autoincrement())
  taskId      Int
  userId      String
  amountCents Int
  type        ProjectTaskPayoutType
  status      ProjectTaskPayoutStatus @default(PENDING)
  createdAt   DateTime                @default(now())
  resolvedAt  DateTime?

  task ProjectTask @relation(fields: [taskId], references: [id])
  user User        @relation(fields: [userId], references: [id])

  @@index([taskId])
  @@index([userId])
}

model CollaborationInvite {
  id          String              @id @default(cuid())
  projectId   Int
  taskId      Int?
  inviterId   String
  inviteeId   String
  status      CollaborationStatus @default(INVITED)
  message     String?
  createdAt   DateTime            @default(now())
  respondedAt DateTime?

  project Project      @relation(fields: [projectId], references: [id])
  task    ProjectTask? @relation(fields: [taskId], references: [id])
  inviter User         @relation("CollaborationInviter", fields: [inviterId], references: [id])
  invitee User         @relation("CollaborationInvitee", fields: [inviteeId], references: [id])

  @@index([projectId])
  @@index([inviteeId])
}

model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String
  title     String
  body      String
  data      Json?
  readAt    DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, readAt])
  @@index([userId, createdAt])
}

model AdminAnnouncement {
  id          String   @id @default(cuid())
  title       String
  body        String
  link        String?
  audience    String   @default("ALL")
  publishedAt DateTime @default(now())
  createdById String?

  createdBy User? @relation(fields: [createdById], references: [id])
}

model AdminReviewQueue {
  id         String    @id @default(cuid())
  feedPostId String?
  projectId  Int?
  shopItemId Int?
  status     String    @default("PENDING")
  reason     String?
  reviewerId String?
  createdAt  DateTime  @default(now())
  reviewedAt DateTime?

  feedPost FeedPost? @relation(fields: [feedPostId], references: [id])
  project  Project?  @relation(fields: [projectId], references: [id])
  shopItem ShopItem? @relation(fields: [shopItemId], references: [id])
  reviewer User?     @relation(fields: [reviewerId], references: [id])

  @@index([status])
  @@index([feedPostId])
  @@index([projectId])
}

model Driver {
  id                   String    @id @default(cuid())
  name                 String
  phone                String
  email                String?
  suburb               String?
  city                 String?
  vehicle              String?
  isActive             Boolean   @default(true)
  rating               Float?
  notes                String?
  createdAt            DateTime  @default(now())
  lastLocationLat      Float?
  lastLocationLng      Float?
  lastLocationAccuracy Float?
  lastLocationAt       DateTime?

  User       User[]
  deliveries Delivery[]
}

model Delivery {
  id                 String         @id @default(cuid())
  orderId            Int            @unique
  driverId           String?
  status             DeliveryStatus @default(PENDING)
  pickupWindowStart  DateTime?
  pickupWindowEnd    DateTime?
  dropoffWindowStart DateTime?
  dropoffWindowEnd   DateTime?
  pickupAt           DateTime?
  deliveredAt        DateTime?
  notes              String?
  trackingCode       String?        @unique
  proofPhotoUrl      String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt

  order  Order   @relation(fields: [orderId], references: [id])
  driver Driver? @relation(fields: [driverId], references: [id])

  @@index([status])
  @@index([driverId])
}

model SupplierQuote {
  id          String   @id @default(cuid())
  orderId     Int
  supplierId  String
  amountCents Int
  notes       String?
  createdAt   DateTime @default(now())

  Order    Order    @relation(fields: [orderId], references: [id])
  Supplier Supplier @relation(fields: [supplierId], references: [id])

  @@index([orderId])
  @@index([supplierId])
}

model SupplierPayout {
  id          String    @id @default(cuid())
  orderId     Int
  supplierId  String
  amountCents Int
  releasedAt  DateTime?
  status      String    @default("PENDING") // PENDING|RELEASED|FAILED

  Order    Order    @relation(fields: [orderId], references: [id])
  Supplier Supplier @relation(fields: [supplierId], references: [id])

  @@index([orderId])
  @@index([supplierId])
}

model AuditLog {
  id        String   @id @default(cuid())
  orderId   Int
  actorId   String? // caretaker or system (User.id)
  action    String // e.g., STATUS_CHANGE, ASSIGN_SUPPLIER, REFUND
  payload   Json?
  createdAt DateTime @default(now())

  Order Order @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([actorId])
}

// =====================
// Room Rentals
// =====================
model RoomListing {
  id               String          @id @default(cuid())
  hostId           String
  addressId        Int
  title            String
  description      String
  nightlyRateCents Int
  monthlyRateCents Int?
  cleaningFeeCents Int?            @default(0)
  currency         String          @default("ZAR")
  maxGuests        Int             @default(1)
  bedrooms         Int?            @default(0)
  beds             Int?            @default(0)
  bathrooms        Float?          @default(0)
  amenities        String[]        @default([])
  houseRules       String[]        @default([])
  coverImage       String?
  gallery          String[]        @default([])
  lat              Float?
  lng              Float?
  isActive         Boolean         @default(true)
  publishedAt      DateTime?
  adminStatus      RoomAdminStatus @default(PENDING)
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  host         User               @relation(fields: [hostId], references: [id])
  address      Address            @relation(fields: [addressId], references: [id])
  media        RoomMedia[]
  availability RoomAvailability[]
  bookings     Booking[]

  @@index([hostId])
  @@index([addressId])
  @@index([adminStatus])
  @@index([lat, lng])
}

model RoomMedia {
  id        String        @id @default(cuid())
  roomId    String
  url       String
  type      RoomMediaType @default(IMAGE)
  position  Int?
  metadata  Json?
  createdAt DateTime      @default(now())

  room RoomListing @relation(fields: [roomId], references: [id])

  @@index([roomId])
}

model RoomAvailability {
  id        String                 @id @default(cuid())
  roomId    String
  startDate DateTime
  endDate   DateTime
  status    RoomAvailabilityStatus @default(BLOCKED)
  reason    String?
  createdAt DateTime               @default(now())

  room RoomListing @relation(fields: [roomId], references: [id])

  @@index([roomId])
  @@index([status])
}

model Booking {
  id               String        @id @default(cuid())
  roomId           String
  guestId          String
  hostId           String
  checkIn          DateTime
  checkOut         DateTime
  guests           Int           @default(1)
  status           BookingStatus @default(PENDING)
  totalCents       Int
  cleaningFeeCents Int?          @default(0)
  taxCents         Int?          @default(0)
  currency         String        @default("ZAR")
  code             String        @unique @default(cuid())
  canceledReason   String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  room    RoomListing     @relation(fields: [roomId], references: [id])
  guest   User            @relation("BookingGuest", fields: [guestId], references: [id])
  host    User            @relation("BookingHost", fields: [hostId], references: [id])
  payment BookingPayment?

  @@index([roomId])
  @@index([guestId])
  @@index([hostId])
  @@index([status])
  @@index([roomId, checkIn])
  @@index([roomId, checkOut])
  @@index([roomId, checkIn, checkOut])
}

model BookingPayment {
  id          String        @id @default(cuid())
  bookingId   String        @unique
  amountCents Int
  currency    String        @default("ZAR")
  status      PaymentStatus @default(PENDING)
  provider    String        @default("PAYSTACK")
  providerRef String?
  receiptUrl  String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  booking Booking @relation(fields: [bookingId], references: [id])

  @@index([status])
}
